let currentFileData = null;
let currentFileName = null;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    updateStepProgress(1);

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => { fileInput.click(); });
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault(); uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFileSelect(files[0]);
    });

    fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileSelect(e.target.files[0]); });
}

function handleFileSelect(file) {
    if (file.type !== 'text/plain' && !file.name.toLowerCase().endsWith('.txt')) {
        alert('Please upload a .txt file');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        currentFileData = e.target.result;
        currentFileName = file.name;
        previewUploadedFile();
    };
    reader.readAsDataURL(file);
}

function previewUploadedFile() {
    showLoading(true, "Previewing file...");
    updateStepProgress(2);

    console.log("Calling do_parse_file with file:", currentFileName);
    
    // Use fetch instead of dataiku.webapp_async_call
    fetch('/your-webapp-prefix/do_parse_file', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_data: currentFileData,
            file_name: currentFileName
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();
    })
    .then(response => {
        console.log("do_parse_file response:", response);
        showLoading(false);
        
        if (response && response.error) {
            alert("Error: " + response.error);
            updateStepProgress(1);
        } else if (response && response.success) {
            displayFilePreview(response);
            updateStepProgress(3);
            // Auto-process after preview
            setTimeout(processAnalysis, 500);
        } else {
            alert("Unexpected response from server");
            updateStepProgress(1);
        }
    })
    .catch(error => {
        console.error("do_parse_file error:", error);
        showLoading(false);
        alert("Preview failed: " + error.message);
        updateStepProgress(1);
    });
}

function processAnalysis() {
    showLoading(true, "Analyzing email chain...");
    console.log("Calling do_analyze_emails...");
    
    fetch('/your-webapp-prefix/do_analyze_emails', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            file_data: currentFileData,
            file_name: currentFileName
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
        }
        return response.json();
    })
    .then(response => {
        console.log("do_analyze_emails response:", response);
        showLoading(false);
        
        if (response && response.error) {
            alert("Analysis error: " + response.error);
        } else if (response && response.success) {
            displayResults(response.results);
        } else {
            alert("Unexpected response from analysis");
        }
    })
    .catch(error => {
        console.error("do_analyze_emails error:", error);
        showLoading(false);
        alert("Analysis failed: " + error.message);
    });
}

function displayFilePreview(data) {
    const previewContent = document.getElementById('previewContent');
    
    let previewHTML = `
        <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 5px;">
            <strong>File:</strong> ${data.file_name || 'Unknown'}<br>
            <strong>Size:</strong> ${data.file_size || 0} bytes<br>
            <strong>Emails Found:</strong> ${data.parsed_emails_count || 0}<br>
            <strong>Participants:</strong> ${(data.participants && data.participants.length > 0) ? data.participants.join(', ') : 'None found'}
        </div>
    `;
    
    if (data.email_preview && data.email_preview.length > 0) {
        previewHTML += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">`;
        previewHTML += `<strong>Email Preview (first ${data.email_preview.length} emails):</strong>`;
        
        data.email_preview.forEach(email => {
            previewHTML += `
                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: white; border-radius: 4px;">
                    <strong>#${email.sequence || 'N/A'}</strong> | <strong>From:</strong> ${email.sender || 'Unknown'}<br>
                    <strong>To:</strong> ${email.receivers || 'Unknown'}<br>
                    <strong>Subject:</strong> ${email.subject || 'No subject'}<br>
                    <strong>Date:</strong> ${email.date || 'Unknown'}<br>
                    <strong>Preview:</strong> ${email.body_preview || 'No content'}
                </div>
            `;
        });
        previewHTML += `</div>`;
    } else {
        previewHTML += `<div style="background: #fff3cd; padding: 15px; border-radius: 5px; color: #856404;">
            <strong>No emails could be parsed from the file.</strong><br>
            Please check that your file has the correct format with "From:", "To:", "Subject:", "Sent:" headers.
        </div>`;
    }
    
    previewContent.innerHTML = previewHTML;
    document.getElementById('filePreview').style.display = 'block';
}

function displayResults(results) {
    const resultsDiv = document.getElementById('resultsContent');
    
    if (!results) {
        resultsDiv.innerHTML = `<div style="background: #f8d7da; padding: 20px; border-radius: 8px; color: #721c24;">
            <h3>No Results Available</h3>
            <p>The analysis did not return any results.</p>
        </div>`;
        document.getElementById('results').style.display = 'block';
        return;
    }
    
    let resultsHTML = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h3 style="color: #198754; margin-bottom: 20px;">Analysis Complete!</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #0d6efd;">
                    <h4>Maker (Requester)</h4>
                    <p style="font-size: 24px; font-weight: bold; color: #0d6efd; margin: 10px 0;">${results.final_maker || "Not identified"}</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #198754;">
                    <h4>Checker (Approver)</h4>
                    <p style="font-size: 24px; font-weight: bold; color: #198754; margin: 10px 0;">${results.final_checker || "Not identified"}</p>
                </div>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <h4>Statistics</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; text-align: center;">
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.total_emails || 0}</strong><br>
                        <small>Total Emails</small>
                    </div>
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.total_participants || 0}</strong><br>
                        <small>Participants</small>
                    </div>
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.potential_makers_count || 0}</strong><br>
                        <small>Potential Makers</small>
                    </div>
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.potential_checkers_count || 0}</strong><br>
                        <small>Potential Checkers</small>
                    </div>
                </div>
            </div>
    `;
    
    // Add resolution method if available
    if (results.resolution_method && results.resolution_method !== 'standard') {
        resultsHTML += `
            <div style="background: #d1ecf1; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <strong>Resolution Method:</strong> ${results.resolution_method}
            </div>
        `;
    }
    
    resultsHTML += `</div>`;
    resultsDiv.innerHTML = resultsHTML;
    document.getElementById('results').style.display = 'block';
}

function showLoading(show, text = "Loading...") {
    const loadingDiv = document.getElementById('loading');
    loadingDiv.style.display = show ? 'flex' : 'none';
    document.getElementById('loadingText').textContent = text;
}

function updateStepProgress(step) {
    const progress = document.getElementById('stepProgress');
    const steps = document.querySelectorAll('.step');
    
    // Update progress bar
    progress.style.width = `${((step - 1) / 2) * 100}%`;
    
    // Update step states
    steps.forEach((el, index) => {
        el.classList.remove('active', 'completed');
        if (index < step - 1) {
            el.classList.add('completed');
        }
        if (index === step - 1) {
            el.classList.add('active');
        }
    });
}
