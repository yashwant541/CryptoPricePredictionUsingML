let currentFileData = null;
let currentFileName = null;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    updateStepProgress(1);

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => { fileInput.click(); });
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault(); uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFileSelect(files[0]);
    });

    fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFileSelect(e.target.files[0]); });
}

function handleFileSelect(file) {
    if (file.type !== 'text/plain' && !file.name.toLowerCase().endsWith('.txt')) {
        alert('Please upload a .txt file');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        currentFileData = e.target.result;
        currentFileName = file.name;
        previewUploadedFile();
    };
    reader.readAsDataURL(file);
}

function previewUploadedFile() {
    showLoading(true, "Previewing file...");
    updateStepProgress(2);

    // Use Dataiku's webapp_async_call
    dataiku.webapp_async_call(
        'do_parse_file',
        {
            file_data: currentFileData,
            file_name: currentFileName
        },
        function(data) {
            showLoading(false);
            if (data.error) {
                alert("Error: " + data.error);
            } else {
                displayFilePreview(data);
                updateStepProgress(3);
                // Auto-process after preview
                processAnalysis();
            }
        },
        function(error) {
            showLoading(false);
            alert("Preview failed: " + error);
        }
    );
}

function processAnalysis() {
    showLoading(true, "Analyzing email chain...");
    
    dataiku.webapp_async_call(
        'do_analyze_emails',
        {
            file_data: currentFileData,
            file_name: currentFileName
        },
        function(data) {
            showLoading(false);
            if (data.error) {
                alert("Analysis error: " + data.error);
            } else {
                displayResults(data.results);
            }
        },
        function(error) {
            showLoading(false);
            alert("Analysis failed: " + error);
        }
    );
}

function displayFilePreview(data) {
    const previewContent = document.getElementById('previewContent');
    
    let previewHTML = `
        <div style="margin-bottom: 20px;">
            <strong>File:</strong> ${data.file_name}<br>
            <strong>Size:</strong> ${data.file_size} bytes<br>
            <strong>Emails Found:</strong> ${data.parsed_emails_count}<br>
            <strong>Participants:</strong> ${data.participants.join(', ')}
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <strong>Email Preview:</strong>
    `;
    
    if (data.email_preview && data.email_preview.length > 0) {
        data.email_preview.forEach(email => {
            previewHTML += `
                <div style="border-bottom: 1px solid #ddd; padding: 10px 0; margin: 10px 0;">
                    <strong>#${email.sequence}</strong> | <strong>From:</strong> ${email.sender}<br>
                    <strong>To:</strong> ${email.receivers}<br>
                    <strong>Subject:</strong> ${email.subject}<br>
                    <strong>Date:</strong> ${email.date}<br>
                    <strong>Preview:</strong> ${email.body_preview}
                </div>
            `;
        });
    } else {
        previewHTML += `<p>No emails preview available</p>`;
    }
    
    previewHTML += `</div>`;
    previewContent.innerHTML = previewHTML;
    document.getElementById('filePreview').style.display = 'block';
}

function displayResults(results) {
    const resultsDiv = document.getElementById('resultsContent');
    
    let resultsHTML = `
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            <h3 style="color: #198754; margin-bottom: 20px;">Analysis Complete!</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #0d6efd;">
                    <h4>Maker (Requester)</h4>
                    <p style="font-size: 24px; font-weight: bold; color: #0d6efd; margin: 10px 0;">${results.final_maker || "Not identified"}</p>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #198754;">
                    <h4>Checker (Approver)</h4>
                    <p style="font-size: 24px; font-weight: bold; color: #198754; margin: 10px 0;">${results.final_checker || "Not identified"}</p>
                </div>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <h4>Statistics</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; text-align: center;">
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.total_emails || 0}</strong><br>
                        <small>Total Emails</small>
                    </div>
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.total_participants || 0}</strong><br>
                        <small>Participants</small>
                    </div>
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.potential_makers_count || 0}</strong><br>
                        <small>Potential Makers</small>
                    </div>
                    <div>
                        <strong style="font-size: 18px;">${results.stats?.potential_checkers_count || 0}</strong><br>
                        <small>Potential Checkers</small>
                    </div>
                </div>
            </div>
    `;
    
    // Add resolution method if available
    if (results.resolution_method && results.resolution_method !== 'standard') {
        resultsHTML += `
            <div style="background: #d1ecf1; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                <strong>Resolution Method:</strong> ${results.resolution_method}
            </div>
        `;
    }
    
    // Add potential candidates if available
    if (results.potential_makers && results.potential_makers.length > 0) {
        resultsHTML += `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <h5>Potential Makers</h5>
                    ${results.potential_makers.map(maker => `
                        <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                            <strong>${maker.participant}</strong>
                            <div style="font-size: 12px; color: #666;">
                                Avg: ${maker.average_score} | Peak: ${maker.highest_score} | Emails: ${maker.email_count}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <h5>Potential Checkers</h5>
                    ${results.potential_checkers.map(checker => `
                        <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                            <strong>${checker.participant}</strong>
                            <div style="font-size: 12px; color: #666;">
                                Avg: ${checker.average_score} | Peak: ${checker.highest_score} | Emails: ${checker.email_count}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    resultsHTML += `</div>`;
    resultsDiv.innerHTML = resultsHTML;
    document.getElementById('results').style.display = 'block';
}

function showLoading(show, text = "Loading...") {
    const loadingDiv = document.getElementById('loading');
    loadingDiv.style.display = show ? 'flex' : 'none';
    document.getElementById('loadingText').textContent = text;
}

function updateStepProgress(step) {
    const progress = document.getElementById('stepProgress');
    const steps = document.querySelectorAll('.step');
    
    // Update progress bar
    progress.style.width = `${((step - 1) / 2) * 100}%`;
    
    // Update step states
    steps.forEach((el, index) => {
        el.classList.remove('active', 'completed');
        if (index < step - 1) {
            el.classList.add('completed');
        }
        if (index === step - 1) {
            el.classList.add('active');
        }
    });
}
