import pandas as pd
import dataiku
import tempfile
import os
import re

# ------------------------------------------------------
# ğŸ”§ Configuration â€” Replace with your Dataiku dataset & folder IDs
# ------------------------------------------------------
input_dataset = dataiku.Dataset("YOUR_INPUT_DATASET_NAME")   # ğŸ“¥ Input Dataiku dataset (CSV)
output_folder = dataiku.Folder("YOUR_OUTPUT_FOLDER_ID")      # ğŸ“¤ Output Dataiku folder

# ------------------------------------------------------
# âš™ï¸ Helper function to clean the Benchmark column
# ------------------------------------------------------
def clean_benchmark(value):
    if pd.isna(value):
        return value
    # Remove substring from '_' up to the next space
    # Example: "FDRA_IN IN" â†’ "FDRA IN"
    return re.sub(r'_[^ ]*', '', value)

# ------------------------------------------------------
# ğŸš€ Read input dataset as DataFrame
# ------------------------------------------------------
df = input_dataset.get_dataframe(infer_with_pandas=True, parse_dates=False, dtypes=str)

print(f"âœ… Loaded dataset with {len(df)} rows and {len(df.columns)} columns")

# ------------------------------------------------------
# ğŸ§¹ Process Benchmark column if it exists
# ------------------------------------------------------
if "Benchmark" in df.columns:
    df["Benchmark"] = df["Benchmark"].apply(clean_benchmark)
    print("âœ… Cleaned 'Benchmark' column successfully")
else:
    print("âš ï¸ 'Benchmark' column not found in dataset â€” no changes applied.")

# ------------------------------------------------------
# ğŸ’¾ Save output CSV into the Dataiku output folder
# ------------------------------------------------------
tmp_dir = tempfile.mkdtemp()
output_path = os.path.join(tmp_dir, "cleaned_benchmark.csv")

df.to_csv(output_path, index=False, encoding="utf-8")

# Upload to Dataiku managed folder
with open(output_path, "rb") as f:
    output_folder.upload_stream("cleaned_benchmark.csv", f)

print("ğŸ‰ Cleaned file saved successfully to Dataiku folder.")
