import os
import tempfile
from docx import Document
import pandas as pd
import pdf2docx
from pdf2docx import Converter
import comtypes.client

def extract_tables_from_docx(docx_path):
    """Extract tables from a Word document"""
    doc = Document(docx_path)
    tables = []
    
    for i, table in enumerate(doc.tables):
        table_data = []
        
        for row in table.rows:
            row_data = []
            for cell in row.cells:
                row_data.append(cell.text.strip())
            table_data.append(row_data)
        
        # Convert to pandas DataFrame for better display
        df = pd.DataFrame(table_data)
        tables.append(f"Table {i + 1}:\n{df.to_string(index=False, header=False)}\n")
    
    if not tables:
        return ["No tables found in document"]
    return tables

def convert_pdf_to_docx(pdf_path):
    """Convert PDF to DOCX using pdf2docx"""
    with tempfile.NamedTemporaryFile(suffix='.docx', delete=False) as temp_file:
        temp_docx_path = temp_file.name
    
    cv = Converter(pdf_path)
    cv.convert(temp_docx_path, start=0, end=None)
    cv.close()
    
    return temp_docx_path

def extract_tables_from_pdf(pdf_path):
    """Extract tables from PDF by first converting to DOCX"""
    try:
        # Convert PDF to temporary DOCX
        temp_docx_path = convert_pdf_to_docx(pdf_path)
        
        # Extract tables from the temporary DOCX
        tables = extract_tables_from_docx(temp_docx_path)
        
        # Clean up temporary file
        os.unlink(temp_docx_path)
        
        if tables == ["No tables found in document"]:
            return ["No tables detected in PDF (conversion didn't reveal tables)"]
        return tables
        
    except Exception as e:
        return [f"Error processing PDF: {str(e)}"]

def get_file_type(prompt):
    """Helper function to get file type with validation"""
    while True:
        file_type = input(prompt).lower().strip()
        if file_type in ['docx', 'pdf']:
            return file_type
        print("Invalid input. Please enter 'docx' or 'pdf'.")

def main():
    print("Advanced Table Extraction Tool")
    print("------------------------------\n")
    print("Note: PDF files will be converted to DOCX for better table extraction\n")
    
    # Get file paths and types
    file1_path = input("Enter path to first file: ").strip()
    file1_type = get_file_type(f"What type is '{file1_path}'? Enter 'docx' or 'pdf': ")
    
    file2_path = input("Enter path to second file: ").strip()
    file2_type = get_file_type(f"What type is '{file2_path}'? Enter 'docx' or 'pdf': ")
    
    # Process files
    print("\nProcessing files...\n")
    
    files = [
        (file1_path, file1_type),
        (file2_path, file2_type)
    ]
    
    for i, (file_path, file_type) in enumerate(files, 1):
        print(f"=== Results for File {i}: {file_path} ({file_type.upper()}) ===")
        
        try:
            if file_type == 'docx':
                tables = extract_tables_from_docx(file_path)
            else:
                tables = extract_tables_from_pdf(file_path)
            
            if not tables:
                print("No tables found in document")
            else:
                for table in tables:
                    print(table)
                    print("-" * 50)
                
        except FileNotFoundError:
            print(f"Error: File not found at {file_path}")
        except Exception as e:
            print(f"Error processing {file_path}: {str(e)}")
        
        print("\n")

if __name__ == "__main__":
    # Check if required packages are installed
    try:
        import pdf2docx
        import comtypes
    except ImportError:
        print("\nERROR: Required packages not installed. Please run:")
        print("pip install pdf2docx comtypes python-docx pandas")
        sys.exit(1)
        
    main()
