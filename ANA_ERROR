import os
import re
import pandas as pd
from dataiku.core.dku_io import Folder

# Specify the input folder
input_folder = Folder("dataiku_csv_folder")  # Replace with your input folder's name

# Get file details from the folder
file_list = input_folder.list_paths_in_partition()
file_info = []

# Process each CSV file in the folder
for file_path in file_list:
    if file_path.endswith(".csv"):  # Process only CSV files
        file_name = os.path.basename(file_path)
        
        # Extract the timestamp (assuming 'YYYYMMDD' format in the name)
        timestamp = "".join(filter(str.isdigit, file_name))
        
        # Extract the number in the filename using regex
        number_in_filename = re.search(r'\d+', file_name)
        number = number_in_filename.group() if number_in_filename else None

        # Read the CSV file to count records
        with input_folder.get_download_stream(file_path) as stream:
            df = pd.read_csv(stream)
            record_count = len(df)  # Count the rows

        # Append the details
        file_info.append({
            "File Name": file_name,
            "Number in Filename": number,  # New column
            "Timestamp": timestamp,
            "Record Count": record_count
        })

# Create a DataFrame from the collected data
output_df = pd.DataFrame(file_info)

# Reorder the columns to ensure 'Number in Filename' is the second column
output_df = output_df[["File Name", "Number in Filename", "Timestamp", "Record Count"]]

# Write the output DataFrame to the output dataset
output_dataset = dataiku.Dataset("consolidated_csv_data")  # Create this output dataset in Dataiku
output_dataset.write_with_schema(output_df)
