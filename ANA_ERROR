import pandas as pd
import io
import os
import dataiku

# ------------------------------------------------------
# ⚙️ CONFIGURATION
# ------------------------------------------------------
use_dataiku = True  # 🔄 Switch for Dataiku / Local usage

if use_dataiku:
    input_folder = dataiku.Folder("YOUR_INPUT_FOLDER_ID")   # Folder with input files
    output_folder = dataiku.Folder("YOUR_OUTPUT_FOLDER_ID") # Folder to save output files
else:
    input_path = r"C:\path\to\input\folder"
    output_path = r"C:\path\to\output\folder"


# ------------------------------------------------------
# 🧠 LOAD ALL FILES
# ------------------------------------------------------
dfs = []

if use_dataiku:
    for file_info in input_folder.list_paths_in_partition():
        filename = os.path.basename(file_info)
        if filename.lower().endswith(('.csv', '.xlsx')):
            with input_folder.get_download_stream(filename) as f:
                if filename.lower().endswith('.csv'):
                    df = pd.read_csv(f, dtype=str)
                else:
                    df = pd.read_excel(f, dtype=str)
                dfs.append(df)
                print(f"✅ Loaded: {filename} | {len(df)} rows")
else:
    for filename in os.listdir(input_path):
        if filename.lower().endswith(('.csv', '.xlsx')):
            full_path = os.path.join(input_path, filename)
            if filename.lower().endswith('.csv'):
                df = pd.read_csv(full_path, dtype=str)
            else:
                df = pd.read_excel(full_path, dtype=str)
            dfs.append(df)
            print(f"✅ Loaded: {filename} | {len(df)} rows")

# ------------------------------------------------------
# 🧩 COMBINE ALL DATA
# ------------------------------------------------------
if dfs:
    combined_df = pd.concat(dfs, ignore_index=True)
    print(f"\n📊 Combined Total Rows: {len(combined_df)}")
else:
    raise ValueError("No valid CSV or Excel files found to combine.")


# ------------------------------------------------------
# 💾 SAVE CONSOLIDATED FILE
# ------------------------------------------------------
if use_dataiku:
    with output_folder.get_writer("ConsolidatedFile.csv") as writer:
        combined_df.to_csv(writer, index=False)
else:
    combined_df.to_csv(os.path.join(output_path, "ConsolidatedFile.csv"), index=False)
print("✅ Saved: ConsolidatedFile.csv")


# ------------------------------------------------------
# 🔍 FILTER CATEGORY != 'DF-4'
# ------------------------------------------------------
filtered_df = combined_df[combined_df['Category'] != 'DF-4']
print(f"📉 Filtered Rows: {len(filtered_df)} (Category != 'DF-4')")

# ------------------------------------------------------
# 💾 SAVE FILTERED FILE
# ------------------------------------------------------
if use_dataiku:
    with output_folder.get_writer("DF_Failure.csv") as writer:
        filtered_df.to_csv(writer, index=False)
else:
    filtered_df.to_csv(os.path.join(output_path, "DF_Failure.csv"), index=False)
print("✅ Saved: DF_Failure.csv")
