import pandas as pd
import dataiku
import tempfile
import os

# ------------------------------------------------------
# ğŸ”§ Configuration â€” Replace with your Dataiku folder IDs
# ------------------------------------------------------
input_folder = dataiku.Folder("XXXXXXXXX")      # ğŸ“¥ Input folder
output_folder = dataiku.Folder("XXXXXXXXX")     # ğŸ“¤ Output folder

# ------------------------------------------------------
# ğŸ§¾ Global Variable â€” Input file to process
# ------------------------------------------------------
FILENAME_TO_PROCESS = "Filename.csv"  # ğŸ‘ˆ Change this filename as needed


# ------------------------------------------------------
# ğŸš€ Main Execution
# ------------------------------------------------------
def main():
    # Get list of input files
    input_files = input_folder.list_paths_in_partition()
    if not input_files:
        raise FileNotFoundError("âŒ No files found in input folder!")

    processed = False

    for file_path in input_files:
        file_name = os.path.basename(file_path)
        print(f"\nğŸ“„ Checking file: {file_name}")

        # Only process the matching file
        if file_name.lower() != FILENAME_TO_PROCESS.lower():
            print(f"â© Skipping {file_name} (not '{FILENAME_TO_PROCESS}')")
            continue

        print(f"âœ… Found target file: {file_name}")

        # ------------------------------------------------------
        # ğŸ“¥ Download the file to a temporary location
        # ------------------------------------------------------
        with input_folder.get_download_stream(file_path) as stream:
            with tempfile.NamedTemporaryFile(delete=False, suffix=".csv") as tmp:
                tmp.write(stream.read())
                tmp_path = tmp.name

        # ------------------------------------------------------
        # ğŸ§  Read data and process
        # ------------------------------------------------------
        df = pd.read_csv(tmp_path, dtype=str)  # preserve all formatting

        if "Tenor" not in df.columns:
            raise ValueError(f"âŒ Column 'Tenor' not found in file {file_name}")

        # Split logic
        df["Tenure"] = df["Tenor"].astype(str).str[-2:]
        df["Type"] = (
            df["Tenor"]
            .astype(str)
            .str[:-2]
            .str.replace("VOL", "", regex=False)
            .str.strip()
        )

        # ------------------------------------------------------
        # ğŸ’¾ Save processed file to output folder
        # ------------------------------------------------------
        output_filename = file_name.replace(".csv", "_Processed.csv")

        with tempfile.NamedTemporaryFile(mode="w", suffix=".csv", delete=False, newline='', encoding="utf-8-sig") as tmp_file:
            df.to_csv(tmp_file.name, index=False)
            with open(tmp_file.name, "rb") as f:
                output_folder.upload_stream(output_filename, f)
            os.remove(tmp_file.name)

        os.remove(tmp_path)
        processed = True
        print(f"âœ… Processed and saved as: {output_filename}")

    if not processed:
        print(f"âš ï¸ No file named '{FILENAME_TO_PROCESS}' was found in the input folder.")
    else:
        print("\nğŸ Completed processing successfully.")


# ------------------------------------------------------
if __name__ == "__main__":
    main()
