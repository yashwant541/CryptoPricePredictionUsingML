import re
import csv
from typing import List, Tuple
import PyPDF2

def extract_text_after_keywords(pdf_path: str, keywords: List[str]) -> List[Tuple[str, str]]:
    """
    Extract text immediately following keyword matches in a PDF.
    
    Args:
        pdf_path: Path to the PDF file
        keywords: List of keywords to search for
        
    Returns:
        List of tuples containing (keyword, text_after_keyword)
    """
    results = []
    
    # Open the PDF file
    with open(pdf_path, 'rb') as file:
        reader = PyPDF2.PdfReader(file)
        
        # Process each page
        for page in reader.pages:
            text = page.extract_text()
            if not text:
                continue
                
            # Search for each keyword
            for keyword in keywords:
                # Create a regex pattern that matches the keyword followed by optional whitespace
                pattern = re.compile(re.escape(keyword) + r'\s*(.*?)(?=\n|$|' + re.escape(keyword) + ')', 
                                    re.IGNORECASE | re.DOTALL)
                
                # Find all matches
                matches = pattern.findall(text)
                for match in matches:
                    # Clean up the matched text (remove leading/trailing whitespace)
                    text_after = match.strip()
                    if text_after:  # Only add if there's actually text after the keyword
                        results.append((keyword, text_after))
    
    return results

def save_to_csv(results: List[Tuple[str, str]], output_path: str):
    """
    Save the extraction results to a CSV file.
    
    Args:
        results: List of tuples from extract_text_after_keywords
        output_path: Path to save the CSV file
    """
    with open(output_path, 'w', newline='', encoding='utf-8') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['Keyword', 'Text After Keyword'])
        writer.writerows(results)

if __name__ == '__main__':
    # Configuration - modify these values
    PDF_PATH = 'input.pdf'          # Path to your input PDF
    OUTPUT_CSV = 'output.csv'       # Path for output CSV
    KEYWORDS = [                    # List of keywords to search for
        'Date:',
        'Invoice Number:',
        'Customer:',
        'Total Amount:',
        # Add more keywords as needed
    ]
    
    # Extract the data
    extracted_data = extract_text_after_keywords(PDF_PATH, KEYWORDS)
    
    # Save to CSV
    save_to_csv(extracted_data, OUTPUT_CSV)
    
    print(f"Successfully extracted {len(extracted_data)} matches to {OUTPUT_CSV}")
