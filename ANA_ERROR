import pandas as pd
import dataiku

# ------------------------------------------------------
# ⚙️ CONFIGURATION
# ------------------------------------------------------
# Replace with your actual dataset names in Dataiku
input_dataset = "input_file_dataset"   # e.g. name of the uploaded CSV dataset
output_dataset = "missing_dates_output"  # e.g. name of output dataset

# Define the start and end date range
start_date = "2025-01-01"
end_date = "2025-01-31"

# Define the date column name in your CSV
date_column = "File Date"

# List of holidays (YYYY-MM-DD)
holidays = [
    '2024-09-18', '2024-10-01', '2024-10-11', '2024-12-25', '2024-12-26', '2025-01-01', '2025-01-29', 
    '2025-01-30', '2025-01-31', '2025-04-04', '2025-04-18', '2025-04-19', '2025-04-21', '2025-05-01', 
    '2025-05-05', '2025-05-31', '2025-07-01'
]

# ------------------------------------------------------
# 📥 READ INPUT DATASET
# ------------------------------------------------------
df = dataiku.Dataset(input_dataset).get_dataframe()

# ------------------------------------------------------
# 🧮 PROCESS DATA
# ------------------------------------------------------
# Convert 'File Date' to date
df[date_column] = pd.to_datetime(df[date_column], errors="coerce").dt.date

# Generate full date range
date_range = pd.date_range(start=start_date, end=end_date).date

# Filter only weekdays and exclude holidays
valid_dates = [
    d for d in date_range
    if d.weekday() < 5 and str(d) not in holidays
]

# Get list of available dates in the dataset
file_dates = set(df[date_column].dropna())

# Identify missing working dates
missing_dates = [d for d in valid_dates if d not in file_dates]

# Prepare result DataFrame
result_df = pd.DataFrame(missing_dates, columns=["Missing Date"])

# ------------------------------------------------------
# 💾 WRITE OUTPUT DATASET
# ------------------------------------------------------
dataiku.Dataset(output_dataset).write_with_schema(result_df)

# ------------------------------------------------------
# 🪶 LOG OUTPUT
# ------------------------------------------------------
if result_df.empty:
    print("\n🎉 No missing working-day dates found!")
else:
    print("\n📅 Missing non-weekend, non-holiday dates:")
    for d in missing_dates:
        print(d)
