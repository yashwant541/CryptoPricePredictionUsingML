import pandas as pd
import dataiku
import tempfile
import os
import re

# ------------------------------------------------------
# ğŸ”§ Configuration â€” Replace with your Dataiku folder IDs
# ------------------------------------------------------
input_folder = dataiku.Folder("XXXXXXX")      # ğŸ“¥ Input folder with CSV files
output_folder = dataiku.Folder("XXXXXXX")     # ğŸ“¤ Output folder for processed CSVs

# ------------------------------------------------------
# âš™ï¸ Helper function to clean the Benchmark column
# ------------------------------------------------------
def clean_benchmark(value):
    if pd.isna(value):
        return value
    # Remove substring starting from '_' up to the next space
    # Example: FDRA_IN IN -> FDRA IN
    return re.sub(r'_[^ ]*', '', value)

# ------------------------------------------------------
# ğŸš€ Process each CSV file in the input folder
# ------------------------------------------------------
available_paths = input_folder.list_paths_in_partition()

for file_path in available_paths:
    if not file_path.lower().endswith(".csv"):
        continue

    filename = os.path.basename(file_path)
    print(f"ğŸ“„ Processing file: {filename}")

    # --- Read CSV file from Dataiku folder ---
    with input_folder.get_download_stream(file_path) as stream:
        df = pd.read_csv(stream, dtype=str, encoding="utf-8")

    # --- Check and clean Benchmark column ---
    if "Benchmark" in df.columns:
        df["Benchmark"] = df["Benchmark"].apply(clean_benchmark)
        print(f"âœ… Cleaned 'Benchmark' column in {filename}")
    else:
        print(f"âš ï¸ 'Benchmark' column not found in {filename}, skipping.")

    # --- Save the cleaned DataFrame to temporary CSV ---
    tmp_dir = tempfile.mkdtemp()
    tmp_path = os.path.join(tmp_dir, filename)
    df.to_csv(tmp_path, index=False, encoding="utf-8")

    # --- Upload the cleaned file to the output Dataiku folder ---
    with open(tmp_path, "rb") as f:
        output_folder.upload_stream(filename, f)

    print(f"ğŸ“¤ Saved cleaned file: {filename}")

print("ğŸ‰ All files processed successfully!")
