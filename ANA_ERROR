import pandas as pd
import dataiku
import io
import os

# ------------------------------------------------------
# âš™ï¸ CONFIGURATION
# ------------------------------------------------------
input_folder = dataiku.Folder("INPUT_FOLDER_ID")    # ğŸ“¥ Replace with your input folder ID
output_folder = dataiku.Folder("OUTPUT_FOLDER_ID")  # ğŸ“¤ Replace with your output folder ID

# Define the start and end date range
start_date = "2024-09-01"
end_date = "2025-08-31"

# Common possible date column names
possible_date_columns = [
    "FileDate", "Date", "file_date", "RunDate", "AsOfDate", "ReportDate"
]

# ------------------------------------------------------
# ğŸ“‚ PROCESS EACH FILE IN INPUT FOLDER
# ------------------------------------------------------
input_files = input_folder.list_paths_in_partition()
print(f"\nğŸ“ Found {len(input_files)} files in the input folder.")

summary_records = []

for file_path in input_files:
    file_name = os.path.basename(file_path)
    print(f"\nğŸ” Processing file: {file_name}")

    # ------------------------------------------------------
    # ğŸ–ï¸ Define holidays based on filename (HARDCODED)
    # ------------------------------------------------------
    if "India" in file_name:
        holidays = [
            "2024-10-02", "2024-10-31", "2024-12-25",
            "2025-01-26", "2025-08-15"
        ]
        country = "India"

    elif "HongKong" in file_name or "HK" in file_name:
        holidays = [
            "2024-09-18", "2024-10-01", "2024-12-25",
            "2025-01-01", "2025-07-01"
        ]
        country = "HongKong"

    elif "Singapore" in file_name or "SG" in file_name:
        holidays = [
            "2024-11-01", "2024-12-25", "2025-01-01",
            "2025-04-18", "2025-05-01"
        ]
        country = "Singapore"

    else:
        holidays = [
            "2024-09-18", "2024-10-01", "2024-10-11",
            "2024-12-25", "2025-01-01"
        ]
        country = "Default"

    print(f"ğŸŒ Using holidays for: {country}")

    # ------------------------------------------------------
    # ğŸ§® Generate working day list for this file
    # ------------------------------------------------------
    date_range = pd.date_range(start=start_date, end=end_date).date
    valid_dates = [d for d in date_range if d.weekday() < 5 and str(d) not in holidays]

    # ------------------------------------------------------
    # ğŸ“¥ Read file from input folder
    # ------------------------------------------------------
    with input_folder.get_download_stream(file_path) as stream:
        if file_name.lower().endswith(".csv"):
            df = pd.read_csv(stream)
        elif file_name.lower().endswith((".xls", ".xlsx")):
            df = pd.read_excel(stream, engine="openpyxl")
        else:
            print(f"âš ï¸ Skipping unsupported file type: {file_name}")
            continue

    # ------------------------------------------------------
    # ğŸ” Detect date column
    # ------------------------------------------------------
    date_col = None
    for col in df.columns:
        if col.strip() in possible_date_columns:
            date_col = col
            break
        if any(keyword.lower() in col.lower() for keyword in ["date", "filedate", "asof"]):
            date_col = col
            break

    if not date_col:
        print(f"âš ï¸ No date column found in {file_name}, skipping.")
        continue

    print(f"ğŸ“… Using date column: {date_col}")

    # ------------------------------------------------------
    # ğŸ§¾ Process completeness
    # ------------------------------------------------------
    df[date_col] = pd.to_datetime(df[date_col], errors="coerce").dt.date
    file_dates = set(df[date_col].dropna())
    missing_dates = [d for d in valid_dates if d not in file_dates]

    result_df = pd.DataFrame(missing_dates, columns=["Missing Date"])
    output_name = f"{os.path.splitext(file_name)[0]}_completeness.csv"

    # ------------------------------------------------------
    # ğŸ’¾ Save output
    # ------------------------------------------------------
    with io.StringIO() as buffer:
        result_df.to_csv(buffer, index=False)
        output_folder.upload_stream(
            output_name,
            io.BytesIO(buffer.getvalue().encode("utf-8"))
        )

    # ------------------------------------------------------
    # ğŸ“Š Summary
    # ------------------------------------------------------
    total_days = len(valid_dates)
    missing_days = len(missing_dates)
    completeness = round(((total_days - missing_days) / total_days) * 100, 2)

    summary_records.append({
        "File Name": file_name,
        "Country": country,
        "Total Working Days": total_days,
        "Missing Days": missing_days,
        "Completeness %": completeness
    })

    if missing_days == 0:
        print(f"ğŸ‰ {file_name}: No missing working-day dates found.")
    else:
        print(f"ğŸ“… {file_name}: {missing_days} missing dates ({completeness}%)")

# ------------------------------------------------------
# ğŸ§¾ Write Combined Summary File
# ------------------------------------------------------
summary_df = pd.DataFrame(summary_records)
with io.StringIO() as buffer:
    summary_df.to_csv(buffer, index=False)
    output_folder.upload_stream("completeness_summary.csv", io.BytesIO(buffer.getvalue().encode("utf-8")))

print("\nâœ… Completeness check finished for all files.")
