import os
import pandas as pd
import extract_msg
from flask import request, jsonify

# Upload directory inside DSS
UPLOAD_DIR = "/tmp/email_uploads"
os.makedirs(UPLOAD_DIR, exist_ok=True)

@app.route('/upload_msg', methods=['POST'])
def upload_msg():
    """Upload .msg file, extract CSV/XLSX, return preview data"""
    if 'file' not in request.files:
        return jsonify({"error": "No file uploaded"}), 400
    
    file = request.files['file']
    msg_path = os.path.join(UPLOAD_DIR, file.filename)
    file.save(msg_path)

    try:
        msg = extract_msg.Message(msg_path)

        dataframes = {}
        extracted_files = []

        for attachment in msg.attachments:
            filename = attachment.longFilename or attachment.shortFilename
            filepath = os.path.join(UPLOAD_DIR, filename)
            with open(filepath, "wb") as f:
                f.write(attachment.data)
            extracted_files.append(filename)

            # Read CSV/XLSX
            if filename.lower().endswith(".csv"):
                df = pd.read_csv(filepath)
                dataframes[filename] = df.head(50).to_dict(orient="records")
            elif filename.lower().endswith(".xlsx"):
                df = pd.read_excel(filepath)
                dataframes[filename] = df.head(50).to_dict(orient="records")

        return jsonify({
            "subject": msg.subject,
            "from": msg.sender,
            "to": msg.to,
            "date": str(msg.date),
            "attachments": extracted_files,
            "data": dataframes
        })

    except Exception as e:
        return jsonify({"error": str(e)}), 500
