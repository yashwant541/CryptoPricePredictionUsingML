import dataiku
import pandas as pd
import zipfile
from io import BytesIO

def read_excel_from_zip(zip_path, excel_tab_name, table_range=None):
    """
    Read a specific tab from Excel file in ZIP archive
    
    Parameters:
    zip_path: path to the ZIP file
    excel_tab_name: name of the tab/sheet to read
    table_range: optional Excel range (e.g., 'A1:D10')
    """
    # Read the input dataset
    zip_dataset = dataiku.Dataset(zip_path)
    
    with zip_dataset.get_raw_data() as raw_data:
        with zipfile.ZipFile(BytesIO(raw_data.read())) as zf:
            # Get the first Excel file (adjust if multiple files)
            excel_files = [f for f in zf.namelist() if f.endswith('.xlsx')]
            if not excel_files:
                raise ValueError("No Excel file found in ZIP")
            
            # Read the Excel file
            with zf.open(excel_files[0]) as excel_file:
                if table_range:
                    df = pd.read_excel(excel_file, sheet_name=excel_tab_name, 
                                     usecols=table_range)
                else:
                    df = pd.read_excel(excel_file, sheet_name=excel_tab_name)
    
    return df

# Main execution
def main():
    # Get input dataset
    input_dataset = dataiku.Dataset("your_zip_dataset_name")  # Replace with your dataset name
    
    # Parameters - adjust these
    TAB_NAME = "Sheet1"  # Replace with your tab name
    TABLE_RANGE = "A:D"  # Optional: specify range like "A1:D100"
    
    # Read the data
    df = read_excel_from_zip(input_dataset.name, TAB_NAME, TABLE_RANGE)
    
    # Write to output dataset
    output_dataset = dataiku.Dataset("your_output_dataset_name")  # Replace with output name
    output_dataset.write_with_schema(df)

if __name__ == "__main__":
    main()
