import os
import fitz  # PyMuPDF
import easyocr
import cv2
import numpy as np

# === Configuration ===
input_folder = r"C:\Users\2011747\Desktop\ScannedPDFs"   # Folder containing scanned PDFs
output_folder = r"C:\Users\2011747\Desktop\OCR_Results"  # Where to save text outputs
os.makedirs(output_folder, exist_ok=True)

# Optional: specify your EasyOCR model folder if offline
model_dir = r"C:\Users\2011747\.EasyOCR\model"

# Initialize EasyOCR (English only here; add more languages if needed)
print("[INFO] Initializing EasyOCR reader...")
reader = easyocr.Reader(['en'], model_storage_directory=model_dir)
print("[INFO] ✅ EasyOCR ready.")

# === Helper Function ===
def pdf_to_images(pdf_path):
    """Convert PDF pages to images using PyMuPDF."""
    print(f"[INFO] Opening PDF: {pdf_path}")
    doc = fitz.open(pdf_path)
    for page_index in range(len(doc)):
        page = doc.load_page(page_index)
        pix = page.get_pixmap(matrix=fitz.Matrix(2, 2))  # 2x scale = better OCR
        img_data = np.frombuffer(pix.tobytes("png"), dtype=np.uint8)
        image = cv2.imdecode(img_data, cv2.IMREAD_COLOR)
        yield page_index + 1, image

# === Process All PDFs in Folder ===
for filename in os.listdir(input_folder):
    if not filename.lower().endswith(".pdf"):
        continue

    pdf_path = os.path.join(input_folder, filename)
    base_name = os.path.splitext(filename)[0]
    output_text_path = os.path.join(output_folder, f"{base_name}.txt")

    all_text = []
    for page_num, image in pdf_to_images(pdf_path):
        print(f"[INFO] Processing page {page_num} of {filename}...")
        results = reader.readtext(image)

        page_text = f"--- Page {page_num} ---\n"
        for (bbox, text, confidence) in results:
            page_text += f"{text}\n"
        all_text.append(page_text)

    with open(output_text_path, "w", encoding="utf-8") as f:
        f.write("\n".join(all_text))
    print(f"[SAVED] OCR text saved at: {output_text_path}")

print("[INFO] ✅ All PDFs processed successfully.")
