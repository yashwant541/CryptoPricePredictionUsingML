import pandas as pd
import dataiku
import tempfile
import os
import shutil

# ------------------------------------------------------
# ðŸ”§ Global configuration
# ------------------------------------------------------

# ðŸ“„ The exact filename you want to process
INPUT_FILENAME = "your_file_name.csv"   # <-- Change this as needed

# 1ï¸âƒ£ Merge rules â€” average Rate for these Type pairs
TYPE_MERGE_RULES = {
    "ATM": ["ATM Ask", "ATM Bid"],
}

# 2ï¸âƒ£ Rename mapping â€” global Type renaming
TYPE_RENAME_MAP = {
    "RR25": "RR",
    "DDR25": "DDRR",
    "BF10": "BF",
    "ATM": "ATM"
}

# ------------------------------------------------------
# ðŸ”„ Processing logic
# ------------------------------------------------------
def merge_and_average_types(df):
    merged_list = []

    for new_type, merge_types in TYPE_MERGE_RULES.items():
        subset = df[df["Type"].isin(merge_types)]
        if not subset.empty:
            grouped = (
                subset.groupby(["Tenor", "Category", "FileDate"], as_index=False)
                .agg({"Rate": "mean"})
            )
            grouped["Type"] = new_type
            merged_list.append(grouped)

    remaining_df = df[~df["Type"].isin([t for v in TYPE_MERGE_RULES.values() for t in v])]
    combined_df = pd.concat([remaining_df] + merged_list, ignore_index=True)
    return combined_df


def rename_types(df):
    df["Type"] = df["Type"].replace(TYPE_RENAME_MAP)
    return df


# ------------------------------------------------------
# ðŸ§¾ Dataiku I/O logic
# ------------------------------------------------------
input_folder = dataiku.Folder("XXXXXX")     # Replace with your input folder ID
output_folder = dataiku.Folder("XXXXXX")    # Replace with your output folder ID

# ðŸ” Locate the target file in the input folder
input_files = input_folder.list_paths_in_partition()
target_file_path = None
for f in input_files:
    if os.path.basename(f) == INPUT_FILENAME:
        target_file_path = f
        break

if not target_file_path:
    raise FileNotFoundError(f"âŒ File '{INPUT_FILENAME}' not found in the input folder.")

# ------------------------------------------------------
# ðŸ“¥ Download file from Dataiku folder
# ------------------------------------------------------
with tempfile.NamedTemporaryFile(delete=False, suffix=".csv") as tmp:
    with input_folder.get_download_stream(target_file_path) as stream:
        shutil.copyfileobj(stream, tmp)  # âœ… Dataiku download stream â†’ temp file
    tmp_path = tmp.name

# Read CSV data
df = pd.read_csv(tmp_path)

# ------------------------------------------------------
# âš™ï¸ Data processing
# ------------------------------------------------------
df_merged = merge_and_average_types(df)
final_df = rename_types(df_merged)

# ------------------------------------------------------
# ðŸ“¤ Upload file back to Dataiku output folder
# ------------------------------------------------------
with tempfile.NamedTemporaryFile(delete=False, suffix=".csv") as tmp_output:
    final_df.to_csv(tmp_output.name, index=False, encoding="utf-8")
    # âœ… Upload stream â€” sends temp file â†’ Dataiku output folder
    with open(tmp_output.name, "rb") as f_out:
        output_folder.upload_stream(INPUT_FILENAME, f_out)

print(f"âœ… Processing complete. File '{INPUT_FILENAME}' saved to the output folder.")
