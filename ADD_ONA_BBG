import pandas as pd
import os

# Path to the folder containing the data files
data_folder = 'path/to/data/folder'
# Path to the master file
master_file_path = 'path/to/master/file.xlsx'
# Filename of the file that uses country codes instead of names
country_code_file = 'filename_with_country_codes.xlsx'

# Read the master file
master_df = pd.read_excel(master_file_path)

# Extract country names and codes from the master file
country_names = set(master_df['Country Name'])
country_codes = set(master_df['Country Code'])

# Define a function to identify country columns in a data file
def identify_country_columns(df, country_set):
    country_columns = [col for col in df.columns if df[col].isin(country_set).all()]
    return country_columns

# Initialize a list to collect mismatches
mismatches = []

# Iterate over all files in the data folder
for filename in os.listdir(data_folder):
    file_path = os.path.join(data_folder, filename)
    
    if filename.endswith('.xlsx'):
        # Read the Excel file, assuming it might have multiple sheets
        xls = pd.ExcelFile(file_path)
        
        for sheet_name in xls.sheet_names:
            data_df = pd.read_excel(xls, sheet_name=sheet_name)
            if filename == country_code_file:
                country_columns = identify_country_columns(data_df, country_codes)
            else:
                country_columns = identify_country_columns(data_df, country_names)
            
            if len(country_columns) == 0:
                mismatches.append((filename, sheet_name, 'No country column identified'))
            elif len(country_columns) > 1:
                mismatches.append((filename, sheet_name, 'Multiple columns with country data found: ' + ', '.join(country_columns)))
            else:
                country_column = country_columns[0]
                if filename == country_code_file:
                    # Check for mismatches in country codes
                    mismatched_codes = set(data_df[country_column]) - country_codes
                    if mismatched_codes:
                        mismatches.append((filename, sheet_name, mismatched_codes))
                else:
                    # Check for mismatches in country names
                    mismatched_countries = set(data_df[country_column]) - country_names
                    if mismatched_countries:
                        mismatches.append((filename, sheet_name, mismatched_countries))

# Report mismatches
if mismatches:
    for filename, sheet_name, mismatch in mismatches:
        print(f"File: {filename}, Sheet: {sheet_name}")
        if isinstance(mismatch, set):
            print(f"Missing: {', '.join(mismatch)}")
        else:
            print(mismatch)
else:
    print("All files contain valid country data.")
