import pandas as pd
import dataiku
import tempfile
import os

# ------------------------------------------------------
# ðŸ”§ Global configuration
# ------------------------------------------------------

# ðŸ“„ The exact filename you want to process from the Dataiku input folder
INPUT_FILENAME = "your_file_name.csv"   # <-- ðŸ” Change this value as needed

# 1ï¸âƒ£ Merge rules â€” average Rate for these Type pairs
TYPE_MERGE_RULES = {
    "ATM": ["ATM Ask", "ATM Bid"],
    # Add more if needed, for example:
    # "RR25": ["RR25 Call", "RR25 Put"],
    # "BF10": ["BF10 Call", "BF10 Put"]
}

# 2ï¸âƒ£ Rename mapping â€” global Type renaming
TYPE_RENAME_MAP = {
    "RR25": "RR",
    "DDR25": "DDRR",
    "BF10": "BF",
    "ATM": "ATM"
}

# ------------------------------------------------------
# ðŸ”„ Processing logic
# ------------------------------------------------------
def merge_and_average_types(df):
    merged_list = []

    # Merge rules â€” average rate for matching Tenor + Category + FileDate
    for new_type, merge_types in TYPE_MERGE_RULES.items():
        subset = df[df["Type"].isin(merge_types)]
        if not subset.empty:
            grouped = (
                subset.groupby(["Tenor", "Category", "FileDate"], as_index=False)
                .agg({"Rate": "mean"})
            )
            grouped["Type"] = new_type
            merged_list.append(grouped)

    # Keep remaining rows not merged
    remaining_df = df[~df["Type"].isin([t for v in TYPE_MERGE_RULES.values() for t in v])]

    # Combine
    combined_df = pd.concat([remaining_df] + merged_list, ignore_index=True)
    return combined_df


def rename_types(df):
    df["Type"] = df["Type"].replace(TYPE_RENAME_MAP)
    return df


# ------------------------------------------------------
# ðŸ§¾ Dataiku I/O logic
# ------------------------------------------------------
# ðŸ“¥ Input and output folders (replace with your actual folder IDs)
input_folder = dataiku.Folder("XXXXXX")     # Input folder ID
output_folder = dataiku.Folder("XXXXXX")    # Output folder ID

# List all files in input folder
input_files = input_folder.list_paths_in_partition()

# Find the specific file to process
target_file_path = None
for f in input_files:
    if os.path.basename(f) == INPUT_FILENAME:
        target_file_path = f
        break

if not target_file_path:
    raise FileNotFoundError(f"âŒ File '{INPUT_FILENAME}' not found in the input folder.")

# Read that specific CSV file
with tempfile.NamedTemporaryFile(delete=False, suffix=".csv") as tmp:
    input_folder.get_download_stream(target_file_path).readinto(tmp)
    tmp_path = tmp.name

df = pd.read_csv(tmp_path)

# ------------------------------------------------------
# âš™ï¸ Processing
# ------------------------------------------------------
df_merged = merge_and_average_types(df)
final_df = rename_types(df_merged)

# ------------------------------------------------------
# ðŸ“¤ Save output to Dataiku output folder
# ------------------------------------------------------
with tempfile.NamedTemporaryFile(delete=False, suffix=".csv") as tmp_output:
    final_df.to_csv(tmp_output.name, index=False, encoding="utf-8")
    output_folder.upload_stream(INPUT_FILENAME, open(tmp_output.name, "rb"))

print(f"âœ… Processing complete. File '{INPUT_FILENAME}' saved to the output folder.")
