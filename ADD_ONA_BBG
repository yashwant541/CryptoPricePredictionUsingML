import dataiku
import extract_msg
import io
import os

# ----------------------------------------------------------
# ✅ Configuration
# ----------------------------------------------------------
input_folder = dataiku.Folder("O6cNhxMz")   # Folder containing MSG files
output_folder = dataiku.Folder("UeSjIQkY")  # Folder where Excel files will be saved

print("🚀 Starting improved MSG Excel extractor (no timestamp usage)")
print("📁 Using Dataiku managed folders (safe mode, no local filesystem).")

# ----------------------------------------------------------
# ✅ Helper: Detect if attachment is Excel
# ----------------------------------------------------------
def is_excel_file(filename, data_bytes):
    """Detect if a file is likely an Excel file."""
    name_lower = (filename or "").lower()
    if name_lower.endswith(('.xlsx', '.xls', '.xlsm')):
        return True
    # Check magic bytes (Excel = ZIP format)
    return data_bytes[:4] == b'PK\x03\x04'

# ----------------------------------------------------------
# ✅ Main Logic
# ----------------------------------------------------------
msg_files = [f for f in input_folder.list_paths_in_partition() if f.lower().endswith(".msg")]
print(f"📬 Found {len(msg_files)} MSG file(s) to process.\n")

for msg_path in msg_files:
    msg_name = os.path.basename(msg_path)
    print(f"📩 Processing MSG: {msg_name}")

    try:
        # Read MSG file bytes
        msg_bytes = input_folder.get_download_stream(msg_path).read()

        # Load using extract_msg (safe mode: no timestamp fields)
        msg = extract_msg.Message(io.BytesIO(msg_bytes))

        if not msg.attachments:
            print("⚠️  No attachments found.\n")
            continue

        print(f"📎 Found {len(msg.attachments)} attachment(s):")
        excel_count = 0

        for i, att in enumerate(msg.attachments, start=1):
            filename = att.longFilename or att.shortFilename or f"attachment_{i}.bin"
            data = att.data

            if is_excel_file(filename, data):
                excel_count += 1
                # Ensure .xlsx extension
                safe_name = filename if filename.lower().endswith(".xlsx") else f"{os.path.splitext(filename)[0]}.xlsx"

                # Upload directly to Dataiku folder
                output_folder.upload_data(safe_name, io.BytesIO(data))
                print(f"   ✅ Saved Excel: {safe_name}")
            else:
                print(f"   ❌ Skipped non-Excel: {filename}")

        print(f"✅ Done {msg_name}: {excel_count} Excel saved.\n")

    except Exception as e:
        print(f"❌ Error processing {msg_name}: {e}\n")

print("🎯 Extraction complete. All Excel attachments saved to Dataiku output folder.")
