import dataiku
import extract_msg
import pandas as pd
import os

# -----------------------------
# CONFIGURATION
# -----------------------------
INPUT_FOLDER_ID = "YOUR_INPUT_FOLDER_ID"   # Replace with your input folder ID
OUTPUT_FOLDER_ID = "YOUR_OUTPUT_FOLDER_ID" # Replace with your output folder ID

# Get Dataiku folders
input_folder = dataiku.Folder(INPUT_FOLDER_ID)
output_folder = dataiku.Folder(OUTPUT_FOLDER_ID)

# Temporary local folders
input_path = input_folder.get_path()
output_path = output_folder.get_path()

# Function to extract all details from a .msg file
def extract_msg_details(msg_file_path):
    msg = extract_msg.Message(msg_file_path)
    msg_sender = msg.sender
    msg_to = msg.to
    msg_cc = msg.cc
    msg_bcc = msg.bcc
    msg_subject = msg.subject
    msg_date = msg.date
    msg_body = msg.body
    # Attachments
    attachments = ", ".join([att.longFilename for att in msg.attachments])
    
    data = {
        "Sender": msg_sender,
        "To": msg_to,
        "CC": msg_cc,
        "BCC": msg_bcc,
        "Subject": msg_subject,
        "Date": msg_date,
        "Body": msg_body,
        "Attachments": attachments
    }
    return data

# -----------------------------
# PROCESS ALL MSG FILES
# -----------------------------
for filename in os.listdir(input_path):
    if filename.lower().endswith(".msg"):
        msg_file_path = os.path.join(input_path, filename)
        try:
            msg_data = extract_msg_details(msg_file_path)
            df = pd.DataFrame([msg_data])
            
            # Output CSV filename (replace .msg with .csv)
            csv_filename = filename.rsplit(".", 1)[0] + ".csv"
            output_file_path = os.path.join(output_path, csv_filename)
            
            df.to_csv(output_file_path, index=False, encoding="utf-8-sig")
            print(f"Processed: {filename}")
        except Exception as e:
            print(f"Failed to process {filename}: {e}")

print("All .msg files processed successfully.")
